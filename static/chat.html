<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"/>
    <title>Chat示例</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        h1 {
            margin: 5vmin auto;
            text-align: center;
            font-size: 5vmin;
        }

        pre {
            margin: 30px;
            font-family: Consolas, Monaco, monospace;;
            border: 1px solid black;
            padding: 10px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        div#out {
            width: 90vw;
            height: 75vh;
            margin: 0 auto;
            margin-top: 5vmin;
        }

        div#display {
            width: 90vw;
            height: 60vh;
            border: 2px solid darkgrey;
            margin: 0 auto;
            overflow: scroll;
            font-size: 4vw;
        }

        #msgbox {
            margin-top: 5vh;
            margin-left:2vw;
            width: 60vw;
            height: 10vh;
            font-size: 6vmin;
            vertical-align: center;
            border: 1px solid black;
        }

        #btn {
            margin-top: 5vh;
            margin-left: 5vw;
            width: 20vw;
            height: 10vh;
            font-size: 6vmin;
            vertical-align: center;
        }
    </style>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            let btn = document.getElementById("btn");
            let display = document.getElementById("display");
            let msgbox =document.getElementById("msgbox");
            //only for recv
            let ws = new WebSocket("ws://" + window.location.hostname + ":8011/");
            //only for post
            let ws2 = new WebSocket("ws://" + window.location.hostname + ":8012/");

            window.myws=ws;
            ws.onmessage=(event)=>{
                display.innerText+="-> "+event.data+"\n";
                display.scrollTo(0, display.scrollHeight);
            };

            btn.onclick = () => {
                display.scrollTo(0, display.scrollHeight);
                ws2.send(msgbox.value);
                msgbox.value='';
            };
            msgbox.onkeypress=(event)=>{
                if(event.code === 'Enter'){
                  btn.click();
                }
            }
        });

    </script>
</head>
<body>
<h2 style="float: left;margin-left: 5vmin; font-size: 3vmin;position: absolute;"><a href="/">返回主页</a></h2>
<h1>Chat示例</h1>
<hr>
<div id="out">
    <div id="display">

    </div>
    <div id="input">
        <input type="text" id="msgbox">
        <button id="btn">Send</button>
    </div>

</div>
<pre>
//只负责订阅消息
ws.redis = redis.newClient();
ws.redis.subscribe("public");
ws.redis.on('message',function(channel,message){
   ws.send(message);
});

//只负责发布消息
ws.redis = redis.newClient();
ws.on('message',function(message){
    ws.redis.publish('public',message);
});
</pre>

</body>
</html>